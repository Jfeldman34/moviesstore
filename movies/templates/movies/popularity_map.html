{% extends 'base.html' %}
{% block content %}
{% load static %}

<div class="container-fluid mt-4">
  <h2>Global Popularity Map</h2>
  <p class="text-muted">Discover what's trending around the world</p>
  
  <!-- Map Container -->
  <div class="row">
    <div class="col-lg-9">
      <div class="card">
        <div class="card-body p-0">
          <div id="world-map" style="height: 600px; width: 100%;"></div>
        </div>
      </div>
      <div class="mt-2">
        <small class="text-muted">Click on a country to see trending movies in that region. Color intensity indicates purchase volume.</small>
      </div>
    </div>
    
    <!-- Region Details Panel -->
    <div class="col-lg-3">
      <div class="card sticky-top" style="top: 20px;">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0" id="region-title">Select a Region</h5>
        </div>
        <div class="card-body" id="region-details" style="max-height: 500px; overflow-y: auto;">
          <p class="text-muted">Click on a country to view trending movies</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- All Regions List -->
  <div class="row mt-4">
    <div class="col-12">
      <h4>All Regions</h4>
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-dark">
            <tr>
              <th>Region</th>
              <th>Total Purchases</th>
              <th>Top Movie</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="regions-table">
            <tr>
              <td colspan="4" class="text-center">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  .leaflet-container {
    background: #a5cef5;
  }
  
  .country-tooltip {
    font-weight: bold;
    font-size: 14px;
  }
  
  .region-card {
    transition: transform 0.2s;
    cursor: pointer;
  }
  
  .region-card:hover {
    transform: translateY(-2px);
  }
  
  .legend {
    background: white;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
  }
  
  .legend i {
    width: 18px;
    height: 18px;
    float: left;
    margin-right: 8px;
    opacity: 0.7;
  }
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let geojsonLayer;
let mapData = null;
let countriesGeoJSON = null;

// Initialize the map
function initMap() {
  map = L.map('world-map', {
    center: [20, 0],
    zoom: 2,
    minZoom: 2,
    maxZoom: 6,
    worldCopyJump: true
  });

  // Add tile layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors',
    noWrap: false
  }).addTo(map);

  // Load data
  Promise.all([
    fetch('/movies/map-data/').then(r => r.json()),
    fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson').then(r => r.json())
  ]).then(([data, geojson]) => {
    mapData = data.regions;
    countriesGeoJSON = geojson;
    renderMap();
    renderRegionsTable();
    addLegend();
  }).catch(error => {
    console.error('Error loading data:', error);
    document.getElementById('region-details').innerHTML = 
      '<p class="text-danger">Error loading map data. Please refresh the page.</p>';
  });
}

// Get color based on purchase count
function getColor(purchases) {
  if (!purchases || purchases === 0) return '#e0e0e0';
  return purchases > 100 ? '#08519c' :
         purchases > 50  ? '#3182bd' :
         purchases > 20  ? '#6baed6' :
         purchases > 10  ? '#9ecae1' :
         purchases > 5   ? '#c6dbef' :
                          '#deebf7';
}

// Style function for countries
function style(feature) {
  const countryName = feature.properties.ADMIN || feature.properties.name;
  const regionData = mapData.find(r => 
    r.region.toLowerCase() === countryName.toLowerCase() ||
    r.region === countryName
  );
  
  const purchases = regionData ? regionData.total_purchases : 0;
  
  return {
    fillColor: getColor(purchases),
    weight: 1,
    opacity: 1,
    color: 'white',
    fillOpacity: 0.7
  };
}

// Highlight feature on hover
function highlightFeature(e) {
  const layer = e.target;
  layer.setStyle({
    weight: 3,
    color: '#666',
    fillOpacity: 0.9
  });
  layer.bringToFront();
}

// Reset highlight
function resetHighlight(e) {
  geojsonLayer.resetStyle(e.target);
}

// Click handler
function onCountryClick(e) {
  const countryName = e.target.feature.properties.ADMIN || e.target.feature.properties.name;
  selectRegion(countryName);
}

// Add feature interactions
function onEachFeature(feature, layer) {
  const countryName = feature.properties.ADMIN || feature.properties.name;
  const regionData = mapData.find(r => 
    r.region.toLowerCase() === countryName.toLowerCase() ||
    r.region === countryName
  );
  
  let popupContent = `<strong>${countryName}</strong><br>`;
  if (regionData && regionData.total_purchases > 0) {
    popupContent += `Purchases: ${regionData.total_purchases}`;
  } else {
    popupContent += 'No purchases yet';
  }
  
  layer.bindTooltip(popupContent, { className: 'country-tooltip' });
  
  layer.on({
    mouseover: highlightFeature,
    mouseout: resetHighlight,
    click: onCountryClick
  });
}

// Render the map with country boundaries
function renderMap() {
  if (geojsonLayer) {
    map.removeLayer(geojsonLayer);
  }
  
  geojsonLayer = L.geoJSON(countriesGeoJSON, {
    style: style,
    onEachFeature: onEachFeature
  }).addTo(map);
}

// Add legend
function addLegend() {
  const legend = L.control({position: 'bottomright'});
  
  legend.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'legend');
    const grades = [0, 5, 10, 20, 50, 100];
    const labels = ['<strong>Purchases</strong>'];
    
    for (let i = 0; i < grades.length; i++) {
      labels.push(
        '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
        grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] : '+')
      );
    }
    
    div.innerHTML = labels.join('<br>');
    return div;
  };
  
  legend.addTo(map);
}

// Select a region and show details
function selectRegion(regionName) {
  const region = mapData.find(r => 
    r.region.toLowerCase() === regionName.toLowerCase() ||
    r.region === regionName
  );
  
  if (!region || region.total_purchases === 0) {
    document.getElementById('region-title').textContent = regionName;
    document.getElementById('region-details').innerHTML = 
      `<p class="text-muted">No purchases recorded for ${regionName} yet.</p>`;
    return;
  }
  
  // Update details panel
  document.getElementById('region-title').textContent = `Trending in ${region.region}`;
  
  let html = `<p><strong>Total Purchases:</strong> ${region.total_purchases}</p>`;
  html += '<h6 class="mt-3">Top Movies:</h6><ol class="list-group list-group-numbered">';
  
  region.top_movies.forEach(movie => {
    html += `
      <li class="list-group-item d-flex justify-content-between align-items-start">
        <div class="ms-2 me-auto">
          <a href="/movies/${movie.id}/" class="fw-bold">${movie.name}</a>
        </div>
        <span class="badge bg-primary rounded-pill">${movie.count}</span>
      </li>
    `;
  });
  
  html += '</ol>';
  document.getElementById('region-details').innerHTML = html;
  
  // Zoom to country if possible
  geojsonLayer.eachLayer(layer => {
    const layerCountry = layer.feature.properties.ADMIN || layer.feature.properties.name;
    if (layerCountry.toLowerCase() === regionName.toLowerCase()) {
      map.fitBounds(layer.getBounds(), { padding: [50, 50] });
    }
  });
}

// Render regions table
function renderRegionsTable() {
  const tbody = document.getElementById('regions-table');
  let html = '';
  
  // Sort by purchases
  const sortedRegions = [...mapData].sort((a, b) => b.total_purchases - a.total_purchases);
  
  sortedRegions.forEach(region => {
    if (region.total_purchases > 0) {
      html += `
        <tr style="cursor: pointer;" onclick="selectRegion('${region.region}')">
          <td><strong>${region.region}</strong></td>
          <td>${region.total_purchases}</td>
          <td>${region.top_movies.length > 0 ? region.top_movies[0].name : 'N/A'}</td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); selectRegion('${region.region}')">
              View Details
            </button>
          </td>
        </tr>
      `;
    }
  });
  
  if (html === '') {
    html = '<tr><td colspan="4" class="text-center text-muted">No purchase data available yet</td></tr>';
  }
  
  tbody.innerHTML = html;
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initMap);
</script>

{% endblock content %}